<?php

use Zend\Session\Container;

$sessionLogin = new Container('credo');

?>

<link rel="stylesheet" type="text/css" href="<?php echo $this->basePath('assets/lib/select2/css/select2.min.css'); ?>"/>
<link rel="stylesheet" type="text/css" href="<?php echo $this->basePath('assets/css/dataTables.bootstrap.min.css'); ?>"/>
<link rel="stylesheet" href="<?php echo $this->basePath('assets/css/daterangepicker-bs3.css'); ?>" type="text/css"/>
<style>
  .auditPointName{
	color:#fff;
	margin:0;
	
	min-width: 200px;
	vertical-align:top;
  }
  
  .auditPointName:hover{
	white-space: normal !important;
	overflow: visible;
	text-overflow: '';
  }
  
  .event a {
    background-color: #8eaffe !important;
    background-image :none !important;
    color: #ffffff !important;
	border-radius:50%;
}


.highcharts-tooltip span {
    width:250px;
    overflow:auto;
    white-space:normal !important;
}

.ms-parent {
  width:100% !important;
}

.title h3{
  display:inline;
  font-weight:400;
}

/*multiselect*/
/*.ui-state-hover, .ui-widget-content .ui-state-hover{color: #1c94c4;border: 1px solid #cccccc;background:none;}
.ui-state-active{color: #1c94c4;border: 1px solid #cccccc;background:none;}
.ui-multiselect-header{display: none;}
*/
.widget-calendar .cal-container .cal-calendar .ui-datepicker table.ui-datepicker-calendar tr td a.ui-state-highlight{
  background: none !important;
  color: #888;
  border:none;
}
.limitBar{color: #555;background-color: #fff;background-image: none;border: 1px solid #ccc;border-radius: 4px;padding: 1px;vertical-align: middle;}
  
.highcharts-legend{display: block !important;}
 
 
.center{
  text-align:center;
} 
</style>
<link rel="stylesheet" href="<?php echo $this->basePath('assets/css/jquery.multiselect.css'); ?>" type="text/css"/>
<script src="<?php echo $this->basePath('assets/js/jquery.js'); ?>" type="text/javascript"></script>
<script src="<?php echo $this->basePath('assets/js/jquery-ui.min.js'); ?>" type="text/javascript"></script>
<script src="<?php echo $this->basePath('assets/js/jquery.multiselect.js'); ?>" type="text/javascript"></script>
      <div class="am-content">
		
        <div class="main-content">
        
		  <div class="row" style="margin-bottom:10px;clear:both;">
			<div class="col-md-6">
			  <div class="widget" style="min-height:440px;">
				<h3>Stepwise Process for Improving the Quality of HIV Rapid Testing (SPI-RT) Checklist</h3>
			  </div>
			</div>
			<div class="col-md-6">
			  <div class="widget">
				<img src="<?php echo $this->basePath('assets/img/odkdash-cycle.png'); ?>" style="width:100%;"/>
			  </div>
			</div>
		  </div>
		  <div class="row">
			<div class="col-md-6">
			  <div class="widget">
				<div class="widget-head">
					<div class="title row">
					  <div class="col-lg-12 col-sm-12 col-md-12">
					  <h3>Performance of High Volume Sites</h3>
					  </div>
					</div>
					
				</div>
				<div class="chart-container" id="testVolumeValues">
				  <div style="width:100%;height:345px" id="volumeChart"></div>
				</div>
			  </div>			  
			</div>			
			
			
			<div class="col-md-6">
			  <div class="widget">
				<div class="widget-head">
				  <span class="title"><h3>Latest Audits</h3></span>
				</div>
				<div class="chart-container">
				  <div id="audit-points-barchart"  style="width:100%;height:345px"></div>
				</div>
			  </div>
			</div>

		  </div>
          <div class="row">
			
			<div class="col-md-6" id="lefter">
                  <div class="widget widget-radar widget-pie">
                    <div class="widget-head">
		      <div class="title row">
                      <div class="col-lg-9 col-sm-9 col-md-9 col-xs-9">
						<h3>Audit Performance</h3>
						
					  </div>
		      </div>
		     
                    </div>
					<div id="radarChart"></div>
				  </div>
				  <div class="widget widget-radar widget-pie">
                    <div class="widget-head">
                      <div class="title row">
						<div class="col-lg-9 col-sm-9 col-md-9 col-xs-9">
						  <h3>Worst Performing Questions</h3>
						</div>
						<div class="col-lg-3 col-sm-3 col-md-3 col-xs-3" style="white-space:nowrap">
						  <label style="">Limit</label>
						  <select class="limitBar" id="limitBar" style="" onchange="getAuditWorstDetails()">
							<option value="5">5</option>
							<option value="10" selected="selected">10</option>
							<option value="15">15</option>
							<option value="20">20</option>
							<option value="30">30</option>
						  </select>
						</div>
					  </div>
		      
					  
					  </div>
                    <div class="chart-container" id="zeroCountChart" style="height:262px;"></div>
                  </div>
				  
			</div>			
			
            <div class="col-md-6" id="righter">
			  <div class="widget widget-map">
				
				
				
				
				
                    <div class="widget-head">
                      <div class="title row">
						<div class="col-lg-9 col-sm-9 col-md-9 col-xs-9">
						  <h3>Audit Locations</h3>
						</div>
					  </div>
		      
					  
					  </div>
				
				
				
				
				
				
                <div class="map-container" id="auditLocations" style="height:1135px;max-height:1500px;">
                  
                </div>
              </div>
            </div>

          </div>
		  
		  <div class="row">
			
			
			<div class="col-md-12 col-sm-12">
			  <div class="widget">
				<div class="widget-head">
				  <span class="title"><h3>Audit Dates</h3></span>
				</div>
				<div class="chart-container">
				  <div style="width:100%;height:340px" id="auditDates"></div>
				</div>
			  </div>			  
			</div>			
			
			

		  </div>
		  
		
		  </div>

        </div>
      </div>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhZa4hDifE6p2sbaxJehS7gcrZOJScIqM&libraries=drawing,geometry,places"></script>

<script src="<?php echo $this->basePath('assets/js/maplace.min.js'); ?>" type="text/javascript"></script>
<script src="<?php echo $this->basePath('assets/lib/select2/js/select2.min.js'); ?>" type="text/javascript"></script>


<script src="<?php echo $this->basePath('assets/js/highcharts.js'); ?>"></script>
<script src="<?php echo $this->basePath('assets/js/highcharts-more.js'); ?>"></script>
<script src="<?php echo $this->basePath('assets/js/pattern-fill.js'); ?>"></script>

<script type="text/javascript" src="<?php echo $this->basePath('assets/js/jquery.dataTables.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->basePath('assets/js/dataTables.bootstrap.min.js'); ?>"></script>
<script src="<?php echo $this->basePath('assets/js/daterangepicker.js'); ?>" type="text/javascript"></script>

    <script type="text/javascript">
		var color1 = "red";
		var color2 = "orange";
		var color3 = "yellow";
		var color4 = "#8DD63E";
		var color5 = "#528A16";

		//Get the template css colors into js vars
		function getColor( c ){
		  var tmp = $("<div>", { class: c }).appendTo("body");
		  var color = tmp.css("background-color");
		  tmp.remove();
	  
		  return color;
		}
  
		var colors = {};
		colors.primary = getColor('clr-primary');
        colors.success = getColor('clr-success');
        colors.info    = getColor('clr-info');
        colors.warning = getColor('clr-warning');
        colors.danger  = getColor('clr-danger');
        colors.alt1    = getColor('clr-alt1');
        colors.alt2    = getColor('clr-alt2');
        colors.alt3    = getColor('clr-alt3');
        colors.alt4    = getColor('clr-alt4');
	
    function bar_chart(){
	
<?php

	$counter = 0;
	$barData = array();
	$volumeData = array();
	$labNameData = array();
	foreach($allSubmissions as $row) {
	  if($counter == 20) break;
	  if($row['AUDIT_SCORE_PERCANTAGE'] < 40){
		$color = '#FF0000';
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 40 && $row['AUDIT_SCORE_PERCANTAGE'] <60){
		$color = '#FFA500';
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 60 && $row['AUDIT_SCORE_PERCANTAGE'] <80){
		$color = '#FFFF00';
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 80 && $row['AUDIT_SCORE_PERCANTAGE'] <90){
		$color = '#8DD63E';
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 90){
		$color = '#528A16';
	  }
	  
	  $barData[] = "{ y : ".round($row['AUDIT_SCORE_PERCANTAGE'],2). ", color : '".$color."' }"; 
	  $volumeData[] = (isset($row['avgMonthTesting']) ? $row['avgMonthTesting'] : 0); 
	  $labNameData[] = ("'Date : ".$this->humanDateFormat($row['assesmentofaudit'])."<br>'"); 
	  $counter++;
	  
	  
	  
	}
?>
	
$('#audit-points-barchart').highcharts({
        chart: {
			zoomType: 'xy'
        },
        title: {
            text: ''
        },
        subtitle: {
            text: ''
        },
        xAxis: {
            categories: [<?php echo implode(",",$labNameData); ?>],
            crosshair: true,
			labels:
			{
			  enabled: false
			}
        },
		  legend: {
            enabled: true
        },
        yAxis: [
		  
		  { // Primary yAxis
            labels: {
                format: '{value}%',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            title: {
                text: 'Audit score in %',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
			min : 0,
			max : 100
        }, { // Secondary yAxis
            title: {
                text: 'Testing Volume',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            labels: {
                format: '{value}',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            opposite: true
        }
        ],
        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="padding:0;font-size:10px">{series.name}: </td>' +
                '<td style="padding:0;font-size:10px">{point.y:.2f}</td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0,
                borderWidth: 0
            }
        },
        series: [{
					  name: 'Audit Score Percentage',
					  data: [<?php echo implode(",",$barData); ?>],
					  stack : 'score',
					  type : 'column',
					  tooltip: {
		                valueSuffix: ' %'
		              }
				  },{
					  name: 'Testing Volume',
					  type : 'column',
					  data: [<?php echo implode(",",$volumeData); ?>],
					  stack : 'volume',
					  color: {
							  pattern : "<?php echo $this->basePath('assets/img/pattern3.png'); ?>",
							  width: 6,
							  height: 6
							 },
					  yAxis: 1,
					  tooltip: {
		                valueSuffix: ' Tests'
		              }
				  }]
    });	
	
    }
    
function getspiRTv3()
{
      $.post("<?php echo $this->url('spi-v3-form', array('action' => 'spirtv3-datewise')); ?>",
      function (data) {
	  $("#dateRangePickerValue").html(data);
      });
}
function getTestingVolumeValue()
{
      $.post("<?php echo $this->url('spi-v3-form', array('action' => 'testing-volume-datewise')); ?>",
      function (data) {
	  
      });
}
function getAuditWorstDetails()
  {
    
    limitBar = $("#limitBar").val();
    
      $.post("<?php echo $this->url('spi-v3-form', array('action' => 'worst-performance')); ?>", {limitBar:limitBar},
      function (data) {
	  $("#zeroCountChart").html(data);
      });
      
  }
  function getAuditDetails()
  {
      
      $.post("<?php echo $this->url('homeAuditPerformance', array('action' => 'audit-performance')); ?>",
      function (data) {
	  $("#radarChart").html(data);
      });
      
  }
  function getAuditLocationDetails()
  {
      $.post("<?php echo $this->url('homeAuditLocations'); ?>",
      function (data) {
	  $("#auditLocations").html(data);
      });
  }

//Calendar Widget
    function calendar_widget(){
    	var widget = $(".widget-calendar");
    	var calNotes = $(".cal-notes", widget);
    	var calNotesDay = $(".day", calNotes);
    	var calNotesDate = $(".date", calNotes);

    	//Calculate the weekday name
    	var d = new Date();
		var weekday = new Array(7);
		weekday[0]=  "Sunday";
		weekday[1] = "Monday";
		weekday[2] = "Tuesday";
		weekday[3] = "Wednesday";
		weekday[4] = "Thursday";
		weekday[5] = "Friday";
		weekday[6] = "Saturday";

		var weekdayName = weekday[d.getDay()];

		calNotesDay.html( weekdayName );

		//Calculate the month name
		var month = new Array();
		month[0] = "January";
		month[1] = "February";
		month[2] = "March";
		month[3] = "April";
		month[4] = "May";
		month[5] = "June";
		month[6] = "July";
		month[7] = "August";
		month[8] = "September";
		month[9] = "October";
		month[10] = "November";
		month[11] = "December";

		var monthName = month[d.getMonth()];
		var monthDay = d.getDate();

		calNotesDate.html( monthName + " " + monthDay);

      if (typeof jQuery.ui != 'undefined') {
		
		
		<?php
		
		$eventDatesArray = array();
		$eventCount = array();
		foreach($allSubmissions as $row) {
		  $humanDate = $this->humanDateFormat($row['assesmentofaudit']);
		  $eventDatesArray[] = "'".$humanDate."'";
		  if(isset($eventCount[$humanDate])){
			$eventCount[$humanDate] = $eventCount[$humanDate] + 1;
		  }else{
			$eventCount[$humanDate] = 1;
		  }
		}
		
		$countJson = json_encode($eventCount);

		if($countJson != null && $countJson != ""){
		?>
		  var countJson = <?php echo $countJson; ?>
		<?php
		}else{
		?>
		  var countJson = null;  
		<?php
		}
		?>
		
		
		var eventDates = [<?php echo implode(",",$eventDatesArray); ?>];
		
		
		
        $( ".ui-datepicker" ).datepicker({
			dateFormat: 'dd-M-yy',
        	onSelect: function(s, o){
        		var sd = new Date(s);
        		var weekdayName = weekday[sd.getDay()];
        		var monthName = month[sd.getMonth()];
				var monthDay = sd.getDate();
				calNotesDay.html( weekdayName );
				calNotesDate.html( monthName + " " + monthDay);
        	},
			beforeShowDay: function(date) {
			  hdate = $.datepicker.formatDate('dd-M-yy', date );
			  if($.inArray(hdate, eventDates) > -1){
				  return [true,"event","Audits on this date : " + countJson[hdate]];
			  }
			  else{
				  return [true,'',"No recorded audits on this date"];
			  }
			}
        });
      }
    }
    function getdata()
    {
    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9+/=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/rn/g,"n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}
    
     value = $("#auditRndNoLocations").val();
     if(value!=null){
      var encodedString = Base64.encode("'"+value+"'");
     window.open('/common/audit-locations?id='+encodedString, '_blank'); 
     }else{
     window.open('/common/audit-locations', '_blank');
     }
    }
      $(document).ready(function(){
      	//initialize the javascript

      $(".select2").select2({
	width: '100%',
	    placeholder: '',
	    allowClear: true,
	    tags : false
      });	
        
        
        
	    getAuditDetails();
        
		bar_chart();
		//zeroCountsBarChart();
		getAuditWorstDetails();
		
		getAuditLocationDetails();

		
		
	  $("#auditRndNo").multipleSelect({placeholder:'Audit round(s)',width: '31%',minimumCountSelected:'2'});
	  $("#auditRndNoLocations").multipleSelect({placeholder:'Select audit round(s)',width: '30%',minimumCountSelected:'2'});
      });
	  
	  
	  
  function approveStatus(id) {
    conf=confirm("Are you sure you want to approve this audit ?");
    if (conf) {
      $.post("<?php echo $this->url('spi-v3-form',array('action'=>'approve-status')); ?>",{id: id},
       function(data) {
        if (data>0) {
            alert("Audit updated successfully");
            window.location.href= window.location;
        }
         
      });
    }
  }
	  
$(function () {
  
  
<?php

	$counter = 0;
	$barData = array();
	$volumeData = array();
	$labNameData = array();
	
	foreach($testingVolume as $row) {
	  if($counter == 10) break;
	  if($row['AUDIT_SCORE_PERCANTAGE'] < 40){
		$color = '#FF0000';
		$level = 0;
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 40 && $row['AUDIT_SCORE_PERCANTAGE'] <60){
		$color = '#FFA500';
		$level = 1;
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 60 && $row['AUDIT_SCORE_PERCANTAGE'] <80){
		$color = '#FFFF00';
		$level = 2;
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 80 && $row['AUDIT_SCORE_PERCANTAGE'] <90){
		$color = '#8DD63E';
		$level = 3;
	  }else if($row['AUDIT_SCORE_PERCANTAGE'] >= 90){
		$color = '#528A16';
		$level = 4;
	  }
	  
	  $levelData[] = "{ y : ".$level. ", color : '".$color."' }"; 
	  $volumeData[] = (isset($row['avgMonthTesting']) ? $row['avgMonthTesting'] : 0); 
	  $testerData[] = (isset($row['NumberofTester']) ? $row['NumberofTester'] : 0); 
	  $labNameData[] = ("'Date : ".$this->humanDateFormat($row['assesmentofaudit'])."<br>'"); 
	  $counter++;
	  
	}
?>  
  
  
    $('#volumeChart').highcharts({
        chart: {
            zoomType: 'xy'
        },
        title: {
            text: ''
        },
        subtitle: {
            text: ''
        },
        xAxis: [{
            categories: [<?php echo implode(",",$labNameData); ?>],
            crosshair: true,
			labels:
			{
			  enabled: false
			}
        }],
        yAxis: [{ 
            labels: {
                format: '{value}',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            title: {
                text: 'No. of Testers',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            opposite: true

        }, { // Secondary yAxis
            gridLineWidth: 0,
            title: {
                text: 'Level',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            labels: {
                format: '{value}',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
			min : 0,
			max : 4,
            opposite: true

        }, { // Tertiary yAxis
            gridLineWidth: 0,
            title: {
                text: 'Testing Volume',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            labels: {
                format: '{value}',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            }
        }],
        tooltip: {
            shared: true
        },
        plotOptions: {
            column: {
                pointPadding: 0,
                borderWidth: 0
            },
        },		
        legend: {
            enabled: true
        },
        series: [ {
            name: 'Testing Volume',
            type: 'column',
            yAxis: 2,
            data: [<?php echo implode(",",$volumeData); ?>],
			color: {
			  pattern : "<?php echo $this->basePath('assets/img/pattern3.png'); ?>",
			  width: 6,
			  height: 6
			},	
            tooltip: {
                valueSuffix: ' Tests'
            }

        }, {
            name: 'Testers',
            type: 'column',
            data: [<?php echo implode(",",$testerData); ?>],
            tooltip: {
                valueSuffix: ' Tests'
            }

        },{
            name: 'Level',
            type: 'column',
            yAxis: 1,
            data: [<?php echo implode(",",$levelData); ?>],
            tooltip: {
                valueSuffix: ' '
            }
			,
			color: '#a058c4',

        }]
    });
    <?php
		$eventDatesArray = array();
		$eventCount = array();
		foreach($allSubmissions as $row) {
		  $humanDate = $this->humanDateFormat($row['assesmentofaudit']);
		  $eventDatesArray[] = "'".$humanDate."'";
		  if(isset($eventCount[$humanDate])){
			$eventCount[$humanDate] = $eventCount[$humanDate] + 1;
		  }else{
			$eventCount[$humanDate] = 1;
		  }
		  
		  if(count($eventCount) >= 40){
			break;
		  }
		}
		
		$eventDatesArray = array_unique($eventDatesArray);
		
	  
?>  	
	
$('#auditDates').highcharts({
        chart: {
            type: 'column'
        },
        title: {
            text: ''
        },
        subtitle: {
            text: ''
        },
        xAxis: {
            categories: [<?php echo implode(",",$eventDatesArray); ?>],
            crosshair: true
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Audit Counts'
            }
        },
		legend :{
		  enabled : false
		},
        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                '<td style="padding:0"><b>{point.y:.0f}</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: 'Audit Counts',
            data: [<?php echo implode(",",$eventCount); ?>]

        }]
    });	
	
	
});
  </script>